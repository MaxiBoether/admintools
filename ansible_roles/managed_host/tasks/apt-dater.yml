- name: install apt-dater client
  apt: package=apt-dater-host

- name: install sudo
  apt: package=sudo

- name: create apt-dater user
  user: name=apt-dater

- name: allow the apt-dater user to use aptitude and apt-get
  lineinfile: " dest=/etc/sudoers.d/apt-dater-host
                line='apt-dater ALL=NOPASSWD: /usr/bin/apt-get, /usr/bin/aptitude'"

- name: make sure there are no other sudo grants for the apt-dater user
  shell: "[ `sudo -lU apt-dater | grep -c NOPASSWD` -eq 1 ]"
  changed_when: false

- name: getting apt-dater's homeâ€¦
  register: apt_dater_home
  shell: "sudo -u apt-dater -i eval 'echo $HOME'"
  changed_when: false
  failed_when: apt_dater_home.stdout == ""

- name: make sure apt-dater's ~/.ssh directory exists
  file: path="{{ apt_dater_home.stdout}}/.ssh"
        state=directory mode=700 owner=apt-dater group=nogroup

- name: check if we are root or sudo'ed
  register: check_root_login
  shell: '[ -z "$SUDO_USER" ]'
  changed_when: false
  failed_when: false

- name: copy authorized key from the root user to apt-dater
  command: cp /root/.ssh/authorized_keys {{ apt_dater_home.stdout}}/.ssh/authorized_keys
  when: check_root_login.rc == 0

- name: copy authorized key from the user to apt-dater
  command: cp /home/{{ ansible_env.SUDO_USER }}/.ssh/authorized_keys {{ apt_dater_home.stdout}}/.ssh/authorized_keys
  when: check_root_login.rc != 0

- name: set rights on apt-dater's authorized keys file
  file: path={{ apt_dater_home.stdout}}/.ssh/authorized_keys
        mode=600 owner=apt-dater group=nogroup
